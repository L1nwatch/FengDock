name: Sync Mind Map

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 2 * * *"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Update mind-map submodule
        run: |
          set -euo pipefail
          git submodule update --init --recursive vendor/mind-map
          cd vendor/mind-map
          git fetch origin
          if git show-ref --verify --quiet refs/remotes/origin/fengdock; then
            git checkout -B fengdock origin/fengdock
          else
            git checkout -B main origin/main
          fi

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: vendor/mind-map/web/package-lock.json

      - name: Build mind-map
        run: |
          set -euo pipefail
          cd vendor/mind-map/web
          npm ci
          npm run build

      - name: Sync build assets
        run: |
          set -euo pipefail
          rm -rf static/mind-map
          mkdir -p static/mind-map
          cp -R vendor/mind-map/dist static/mind-map/dist
          cp vendor/mind-map/index.html static/mind-map/index.html

      - name: Commit updates
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add vendor/mind-map static/mind-map
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore: sync mind-map build"
          git push
